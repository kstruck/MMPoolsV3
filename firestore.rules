rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // POOLS: 
    // - READ: Everyone (Public)
    // - CREATE: Logged in users
    // - UPDATE: 
    //   - Allow Owner to update (for settings, managing players)
    //   - DENY others (Public users claiming squares must use Cloud Function 'reserveSquare')
    //   - DENY 'isLocked', 'axisNumbers' updates from Client (must use Cloud Function 'lockPool') - enforce via field check if owner?
    //     - Actually, even Owner should use lockPool for RNG.
    //     - But Owner might need to toggle lock manually? 
    //     - Let's restrict 'axisNumbers' to only be writable if unchanged or via Admin SDK (which bypasses rules).
    //     - So: allow update if request.auth.uid == resource.data.ownerId && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['axisNumbers']))
    // - DELETE: Owner only
    
    // POOLS:
    match /pools/{poolId} {
      // Allow GET by anyone (Guest Access via Link)
      allow get: if true;
      
      // Allow LIST only if you are the owner (Manager Dashboard)
      allow list: if request.auth != null && resource.data.ownerId == request.auth.uid;


      
      // Delete: Owner only
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      
      // Update: Owner only, but filtered fields
      // Prevent CLIENTS from writing to 'squares', 'axisNumbers', 'participants' directly
      // They must use Cloud Functions (reserveSquare, lockPool, etc.)
      allow update: if request.auth != null && request.auth.uid == resource.data.ownerId 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['axisNumbers', 'squares']));
                    
      // NO CREATE via Client (Must use createPool function)
      allow create: if false;

      // PARTICIPANTS INDEX (Subcollection)
      // Read: Pool Owner OR The Participant themselves
      match /participants/{participantId} {
        allow read: if request.auth != null && (
          request.auth.uid == participantId || 
          get(/databases/$(database)/documents/pools/$(poolId)).data.ownerId == request.auth.uid
        );
        allow write: if false; // Only via Cloud Functions
      }

      // AUDIT LOGS: Encapsulated logic (No Client Writes)
      match /audit/{auditId} {
        allow read: if true;
        allow write, delete: if false; 
      }

      // AI COMMISSIONER
      match /ai_artifacts/{docId} {
        allow read: if true;
        allow write: if false;
      }
      
      match /ai_requests/{docId} {
         allow read: if request.auth != null;
         allow create: if request.auth != null 
                       && request.resource.data.userId == request.auth.uid;
         allow update, delete: if false; 
      }
    }
    
    // USERS & PARTICIPATIONS:
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
                   && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])); // Deny role update

      // PARTICIPATIONS (Dashboard Index)
      match /participations/{poolId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false; // Only via Cloud Functions
      }
    }

    // POOL CLAIMS (Cross-Device Merge)
    // Completely secure, only accessed via Cloud Functions
    match /poolClaims/{claimId} {
      allow read, write: if false;
    }

    // STATS:
    match /stats/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // EMAIL TRIGGERS:
    // - Public write allowed (for now, to support legacy client-side trigger)
    match /mail/{document=**} {
      allow create: if true;
    }
  }
}
