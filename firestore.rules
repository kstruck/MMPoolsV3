rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // POOLS: 
    // - READ: Everyone (Public)
    // - CREATE: Logged in users
    // - UPDATE: 
    //   - Allow Owner to update (for settings, managing players)
    //   - DENY others (Public users claiming squares must use Cloud Function 'reserveSquare')
    //   - DENY 'isLocked', 'axisNumbers' updates from Client (must use Cloud Function 'lockPool') - enforce via field check if owner?
    //     - Actually, even Owner should use lockPool for RNG.
    //     - But Owner might need to toggle lock manually? 
    //     - Let's restrict 'axisNumbers' to only be writable if unchanged or via Admin SDK (which bypasses rules).
    //     - So: allow update if request.auth.uid == resource.data.ownerId && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['axisNumbers']))
    // - DELETE: Owner only
    
    match /pools/{poolId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerId;
      allow update: if request.auth != null && request.auth.uid == resource.data.ownerId 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['axisNumbers']));


      // AUDIT LOGS: Encapsulated logic
      // - Read: Everyone
      // - Write/Delete: NO ONE (Clients). Only Server (Admin SDK) bypasses this.
      match /audit/{auditId} {
        allow read: if true;
        allow write, delete: if false; 
      }

      // AI COMMISSIONER
      match /ai_artifacts/{docId} {
        allow read: if true;
        allow write: if false; // Only server writes
      }
      
      match /ai_requests/{docId} {
         allow read: if request.auth != null;
         allow create: if request.auth != null 
                       && request.resource.data.userId == request.auth.uid;
         allow update, delete: if false; 
      }
    }
    
    // USERS:
    // - Read: Authenticated users (so SuperAdmin can list them)
    // - Write: Self only
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // EMAIL TRIGGERS:
    // - Public write allowed (for now, to support legacy client-side trigger)
    match /mail/{document=**} {
      allow create: if true;
    }
  }
}
