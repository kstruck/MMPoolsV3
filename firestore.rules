rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // POOLS: 
    // - READ: Everyone (Public)
    // - CREATE: Logged in users
    // - UPDATE: 
    //   - Allow Owner to update (for settings, managing players)
    //   - DENY others (Public users claiming squares must use Cloud Function 'reserveSquare')
    //   - DENY 'isLocked', 'axisNumbers' updates from Client (must use Cloud Function 'lockPool') - enforce via field check if owner?
    //     - Actually, even Owner should use lockPool for RNG.
    //     - But Owner might need to toggle lock manually? 
    //     - Let's restrict 'axisNumbers' to only be writable if unchanged or via Admin SDK (which bypasses rules).
    // PROP QUESTIONS (Global Seeds)
    match /prop_questions/{questionId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPER_ADMIN';
    }

    // POOLS:
    match /pools/{poolId} {
      // Allow GET by anyone (Guest Access via Link)
      allow get: if true;
      
      // Allow LIST if you are owner, superadmin, OR if querying for public pools
      // Allow LIST if:
      // 1. Pool is Public (Squares root flag OR Playoff settings flag)
      // 2. Pool has a URL Slug (enables resolving slugs for guests, even if private)
      // 3. User is Owner/Manager/SuperAdmin
      allow list: if (resource.data.get('isPublic', false) == true) || 
                     (resource.data.get('settings', {}).get('isListedPublic', false) == true) ||
                     (resource.data.get('urlSlug', null) != null) ||
                     (request.auth != null && (
                        resource.data.ownerId == request.auth.uid || 
                        resource.data.managerUid == request.auth.uid || 
                        resource.data.entries[request.auth.uid] != null ||
                        (resource.data.participantIds != null && resource.data.participantIds.hasAny([request.auth.uid])) ||
                        isSuperAdmin()
                     ));

      
      // Delete: Owner only OR SuperAdmin
      allow delete: if request.auth != null && (request.auth.uid == resource.data.ownerId || request.auth.uid == resource.data.managerUid || isSuperAdmin());
      
      // Update: Owner only (filtered) OR SuperAdmin (unrestricted)
      // Prevent CLIENTS from writing to 'squares', 'axisNumbers', 'participants' directly
      // They must use Cloud Functions (reserveSquare, lockPool, etc.)
      allow update: if request.auth != null && (
        ((request.auth.uid == resource.data.ownerId || request.auth.uid == resource.data.managerUid) && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['axisNumbers', 'squares']))) 
        || isSuperAdmin()
      );
                    
      // NO CREATE via Client (Must use createPool function)
      allow create: if false;

      // WINNERS (Subcollection)
      // Read: Everyone (Publicly visible results)
      match /winners/{winnerId} {
        allow read: if true;
        allow write: if false; // Only via Cloud Functions
      }

      // PARTICIPANTS INDEX (Subcollection)
      // Read: Pool Owner OR The Participant themselves OR SuperAdmin
      match /participants/{participantId} {
        allow read: if request.auth != null && (
          request.auth.uid == participantId || 
          get(/databases/$(database)/documents/pools/$(poolId)).data.ownerId == request.auth.uid ||
          isSuperAdmin()
        );
        allow write: if false; // Only via Cloud Functions
      }

      // AUDIT LOGS: Encapsulated logic (No Client Writes)
      match /audit/{auditId} {
        allow read: if true;
        allow write, delete: if false; 
      }

      // AI COMMISSIONER
      match /ai_artifacts/{docId} {
        allow read: if true;
        allow write: if false;
      }
      
      match /ai_requests/{docId} {
         allow read: if request.auth != null;
         allow create: if request.auth != null 
                       && request.resource.data.userId == request.auth.uid;
         allow update, delete: if false; 
      }

      // ANNOUNCEMENTS
      match /announcements/{announcementId} {
        allow read: if true;
        allow create: if request.auth != null && (
          get(/databases/$(database)/documents/pools/$(poolId)).data.ownerId == request.auth.uid ||
          get(/databases/$(database)/documents/pools/$(poolId)).data.managerUid == request.auth.uid ||
          isSuperAdmin()
        );
      }

      // PROP CARDS
      match /propCards/{userId} {
        // Read: Owner (Admin), The User themselves, or SuperAdmin
        allow read: if request.auth != null;
        // Write: Only via Cloud Function 'purchasePropCard' normally, but allow SuperAdmin for tests/edits
        allow write: if isSuperAdmin();
      }

      // BRACKET/PLAYOFF ENTRIES
      match /entries/{entryId} {
        allow read: if request.auth != null;
        allow write: if isSuperAdmin();
      }
    }
    
    // USERS & PARTICIPATIONS:
    match /users/{userId} {
      allow read: if request.auth != null;

      // Allow write if:
      // 1. User editing themselves (BUT denying role change)
      // 2. SuperAdmin editing anyone (Allowed to change roles too)
      allow write: if request.auth != null && (
        (request.auth.uid == userId && (
          // CREATE: Allow if creating self, provided role is PARTICIPANT (prevent self-promotion)
          (resource == null && request.resource.data.role == 'PARTICIPANT') ||
          // UPDATE: Allow if updating self, provided role is NOT changed
          (resource != null && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
        )) ||
        isSuperAdmin()
      );

      // PARTICIPATIONS (Dashboard Index)
      match /participations/{poolId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false; // Only via Cloud Functions
      }
    }

    // POOL CLAIMS (Cross-Device Merge)
    // Completely secure, only accessed via Cloud Functions
    match /poolClaims/{claimId} {
      allow read, write: if false;
    }

    // SLUGS (For availability check)
    match /slugs/{slug} {
      allow get: if true;
    }

    // GLOBAL CONFIG (Playoffs, etc.)
    match /config/{configId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // SYSTEM DOCUMENTS (Config, Playoff Results, etc.)
    match /system/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // SYSTEM LOGS
    match /system_logs/{document=**} {
      allow read: if isSuperAdmin();
      allow write: if false; 
    }

    // TOURNAMENTS (March Madness Data)
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // STATS:
    match /stats/{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // POOL THEMES
    match /themes/{themeId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // EMAIL TRIGGERS:
    // - Public write allowed (for now, to support legacy client-side trigger)
    match /mail/{document=**} {
      allow create: if true;
    }
  }
}
